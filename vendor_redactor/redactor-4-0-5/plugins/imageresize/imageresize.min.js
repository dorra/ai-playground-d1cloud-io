Redactor.add("plugin","imageresize",{translations:{en:{imageresize:{"image-resize":"Image resize"}}},defaults:{minHeight:20,minWidth:100,zIndex:96},subscribe:{"editor.blur, editor.select":function(){this.stop()},"image.position":function(){this._setResizerPosition()},"block.set":function(e){this._load()},"source.before.open":function(){this._hide()},"image.outset, image.wrap, fullscreen.open, fullscreen.close":function(){this.updatePosition()}},stop(){this._remove(),this._stopEvents()},updatePosition(){this._setResizerPosition()},_load(){var e=this.app.block.get();this._remove(),e&&e.isType("image")&&this._build(e)},_build(e){this.$block=e.getBlock(),this.$image=e.getImage(),this.resizer=this.dom("<span>"),this.resizer.attr("id","rx-image-resizer"),this.resizer.css({position:"absolute","background-color":"#046BFB","min-width":"8px","min-height":"22px",padding:"3px 4px","border-radius":"4px","font-size":"12px","line-height":"1",color:"#fff",border:"2px solid #fff",cursor:"ew-resize"}),this.app.$body.append(this.resizer),this._setResizerPosition(),setTimeout(this._setResizerPosition.bind(this),30),this._buildWidth(),this._buildDepth(),this._buildEvents(),this.resizer.on("mousedown touchstart",this._press.bind(this))},_buildDepth(){this.resizer.css("z-index",this.opts.get("imageresize.zIndex")),this.opts.is("bsmodal")&&this.resizer.css("z-index",1061),this.app.isProp("fullscreen")&&this.resizer.css("z-index",10001)},_setResizerPosition(){if(this.$image){let e=this.$image.offset();var i,t,s=this.$image.width(),r=this.$image.height(),h=this.resizer.width(),o=this.resizer.height(),a=(this.app.scroll.isTarget()&&(e=(i=e,t=this.$image.get(),"fixed"!==(a=this.app.scroll.getTarget().get()).style.position?i:(i=t.getBoundingClientRect(),t=a.getBoundingClientRect(),{top:i.top+window.scrollY-t.top,left:i.left+window.scrollX-t.left}))),Math.round(e.top+r/2-o/2));this._buildDepth(),this.resizer.css({top:a+"px",left:Math.round(e.left+s-h+8)+"px"}),this.resizer.show(),this.app.scroll.isTarget()&&(t=(i=this.app.scroll.getTarget()).offset().top+i.height(),r=i.offset().top,o=a+this.resizer.height(),s=parseInt(i.css("padding-top")),t<o||a<r+s)&&this.resizer.hide(),this.opts.is("maxHeight")&&(o=(h=this.app.editor.getEditor()).offset().top+h.height(),r=h.offset().top,o<a+this.resizer.height()||a<r)&&this.resizer.hide()}},_press(e){e.preventDefault();var i=this.$image.height(),t=this.$image.width();this.resizeHandle={x:e.pageX,y:e.pageY,el:this.$image,ratio:t/i,h:i,w:t},this.app.event.pause(),this.app.getDoc().on("mousemove.rx-image-resize touchmove.rx-image-resize",this._move.bind(this)),this.app.getDoc().on("mouseup.rx-image-resize touchend.rx-image-resize",this._release.bind(this)),this.app.broadcast("image.resize.start",{e:e,block:this.$block,image:this.$image})},_buildEvents(){var e=this.app.scroll.getTarget();e.on("resize.rx-image-resize",this.updatePosition.bind(this)),e.on("scroll.rx-image-resize",this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll.rx-image-resize",this.updatePosition.bind(this))},_buildWidth(){var e=this.app.create("utils").cssToObject(this.$image.attr("style"));(e.width||e.height)&&(this._width=!0)},_move(e){e.preventDefault();var i=(r=this._getWidth(e))/this.resizeHandle.ratio,t=this.resizeHandle.el,s=this.opts.get("imageresize"),i=Math.round(i),r=Math.round(r);i<s.minHeight||r<s.minWidth||this._getResizableBoxWidth()<=r||(t.attr({width:r,height:i}),this._width&&t.css({width:r+"px",height:i+"px"}),this.resizer.text(r+"px"),this._setResizerPosition(),this.app.control.updatePosition(),this.app.broadcast("image.resize.move",{e:e,block:this.$block,image:this.$image}))},_release(e){this.app.create("cleaner").cacheElementStyle(this.$image),this._stopEvents(),this.app.block.set(this.$block),setTimeout(function(){this.app.event.run()}.bind(this),10),this.resizer.text(""),this._setResizerPosition(),this.app.broadcast("image.resize.stop",{e:e,block:this.$block,image:this.$image})},_stopEvents(){this.app.getDoc().off(".rx-image-resize"),this.app.editor.getEditor().off(".rx-image-resize")},_hide(){this.app.$body.find("#rx-image-resizer").hide()},_show(){this.app.$body.find("#rx-image-resizer").show()},_remove(){this.app.$body.find("#rx-image-resizer").remove()},_getWidth(e){let i=this.resizeHandle.w;return e.targetTouches?i+=e.targetTouches[0].pageX-this.resizeHandle.x:i+=e.pageX-this.resizeHandle.x,i},_getResizableBoxWidth(){var e=this.app.editor.getEditor();return e.width()-parseInt(e.css("padding-left"))-parseInt(e.css("padding-right"))}});