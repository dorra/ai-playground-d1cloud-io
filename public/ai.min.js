Redactor.add("plugin","ai",{translations:{en:{ai:{"placeholder-image":"Describe the image you want to generate.","placeholder-text":"Tell me what you want to write.",send:"Send",stop:"Stop",discard:"Discard",insert:"Insert",prompt:"Prompt","image-style":"Image style","change-tone":"Change tone"}}},dropdowns:{items:{improve:{title:"Improve it",command:"ai.set",params:{prompt:"Improve it"}},simplify:{title:"Simplify it",command:"ai.set",params:{prompt:"Simplify it"}},fix:{title:"Fix any mistakes",command:"ai.set",params:{prompt:"Fix any mistakes"}},shorten:{title:"Make it shorter",command:"ai.set",params:{prompt:"Make it shorter"}},detailed:{title:"Make it more detailed",command:"ai.set",params:{prompt:"Make it more detailed"}},complete:{title:"Complete sentence",command:"ai.set",params:{prompt:"Complete sentence"}},tone:{title:"Change tone",command:"ai.popupTone"},translate:{title:"Translate",command:"ai.popupTranslate"}}},defaults:{tone:["Academic","Assertive","Casual","Confident","Constructive","Empathetic","Exciting","Fluent","Formal","Friendly","Inspirational","Professional"],style:["3d model","Digital art","Isometric","Line art","Photorealistic","Pixel art"],translate:["Arabic","Chinese","English","French","German","Greek","Italian","Japanese","Korean","Portuguese","Russian","Spanish","Swedish","Ukrainian"],size:{"1792x1024":"Landscape","1024x1792":"Portrait","1024x1024":"Square"},text:{stream:!0},makeit:"Make it",translateto:"Translate to",spinner:'<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>.spinner_nOfF{animation:spinner_qtyZ 2s cubic-bezier(0.36,.6,.31,1) infinite}.spinner_fVhf{animation-delay:-.5s}.spinner_piVe{animation-delay:-1s}.spinner_MSNs{animation-delay:-1.5s}@keyframes spinner_qtyZ{0%{r:0}25%{r:3px;cx:4px}50%{r:3px;cx:12px}75%{r:3px;cx:20px}100%{r:0;cx:20px}}</style><circle class="spinner_nOfF" cx="4" cy="12" r="3"/><circle class="spinner_nOfF spinner_fVhf" cx="4" cy="12" r="3"/><circle class="spinner_nOfF spinner_piVe" cx="4" cy="12" r="3"/><circle class="spinner_nOfF spinner_MSNs" cx="4" cy="12" r="3"/></svg>'},observe(t,e,s){if(("ai-tools"!==e||this.opts.is("ai.text.url"))&&("ai-image"!==e||this.opts.is("ai.image.url")))return t},popup(t,e){var s;"addbar"!==this.app.dropdown.getName()?(s=this.app.create("dropdown","ai-tools",{items:this.opts.get("ai.items")||this.dropdowns.items}),this.app.dropdown.open(t,e,s)):this._buildPrompt()},promptImage(t,e){this._buildPrompt({image:!0})},popupTone(t,e){var s={},i=this.opts.get("ai.tone")||this.defaults.tone,r=this.opts.get("ai.makeit")||this.defaults.makeit;for(let t=0;t<i.length;t++)s[t]={title:i[t],command:"ai.set",params:{prompt:r+" "+i[t]}};var a=this.app.create("dropdown","ai-tone",{items:s});this.app.dropdown.open(t,e,a)},popupTranslate(t,e){var s={},i=this.opts.get("ai.translate")||this.defaults.translate,r=this.opts.get("ai.translateto")||this.defaults.translateto;for(let t=0;t<i.length;t++)s[t]={title:i[t],command:"ai.set",params:{prompt:r+" "+i[t]}};var a=this.app.create("dropdown","ai-translate",{items:s});this.app.dropdown.open(t,e,a)},set(t,e){this.promptButton=e;var e=this._getText(),s=this._getHtml(),t=(""!==e&&this.promptButton.setIcon(this.defaults.spinner),t.prompt),t=this.app.broadcast("ai.create",{prompt:t}).get("prompt");this._setPrompt(e,s,t)},sendPrompt(e){e.preventDefault(),e.stopPropagation();var e=this.opts.get("ai."+this.promptType+".model"),s=this._getMessage();if(""!==s){var i=this._getTone(s),i=("text"===this.promptType&&(this.conversation.push({role:"user",content:s}),i)&&this.conversation.push({role:"user",content:i}),{model:e,stream:this.opts.get("ai.text.stream"),messages:this.conversation});let t="1024x1024";"image"===this.promptType&&(t=this.$size.val());s=this.app.broadcast("ai.create",{prompt:s}).get("prompt"),i="image"===this.promptType?{model:e,n:1,size:t,prompt:s}:i;this.$progress.html(this.defaults.spinner),"image"!==this.promptType&&this.opts.is("ai.text.stream")?this._sendStream(this.$preview,s,!0):this._sendPrompt(i,"_complete")}},insertPrompt(t){t.preventDefault(),t.stopPropagation();let e=this.app.create("insertion"),s=this.$preview.html();setTimeout(function(){this.app.block.setTool(!1);var t=e.insert({html:s,target:this.$prompt,position:"before"});this.$prompt.remove(),this.conversation=[],this.app.broadcast("ai.insert",{nodes:t})}.bind(this),3)},stopPrompt(t,e){t&&(t.preventDefault(),t.stopPropagation(),e=this.$preview.text(),this.isEvent)&&this.isEvent.close(),this.$preview.css({"white-space":""}),this.$preview.html(this._parseReply(e)),this.$insert.show(),this.$stop.hide(),this.$generate.show();var s=t?"ai.stop":"ai.complete",i=this.$previewLabel.text(),t=t?{prompt:i}:{prompt:i,response:this._parseReply(e)};this.app.broadcast(s,t)},closePrompt(t){t.preventDefault(),t.stopPropagation(),this.app.block.setTool(!1),this.$prompt.remove(),this.conversation=[],this.isEvent&&this.isEvent.close(),this.app.broadcast("ai.discard")},_getTone(t){var e=this.$select.val();return"0"!==e&&"1"!==e&&`${this.opts.get("ai.makeit")||this.defaults.makeit} `+e},_getHtml(){let e="",s=this.app.blocks.get({selected:!0,instances:!0});var t=this.app.block.get();0===s.length&&t&&(s=[t]);for(let t=0;t<s.length;t++)e+=s[t].getOuterHtml();return e},_getText(){let e="",s=this.app.blocks.get({selected:!0,instances:!0});var i,t=this.app.block.get();0===s.length&&t&&(s=[t]);for(let t=0;t<s.length;t++)s[t].isEditable()&&(i=s[t].getType(),e=e+("listitem"===i?"- ":"")+s[t].getPlainText()+"\n");return e=(e=e.trim()).replace(/\n$/,"")},_getMessage(){return this.$textarea.val().trim()},_getNode(){var t=this.app.block.create().getBlock();return this._buildNode(t,{traverse:!0})},_getInsertedNode(){let t=this.dom('<div class="rx-inserted-node" style="white-space: pre-wrap;">');return t.html(this.opts.get("ai.spinner")),t=this._buildNode(t,{traverse:!1})},_setPrompt(t,e,s){""!==t&&(this.promptType="text",this.promptText=t,this.promptHtml=e,e=[{role:"user",content:t},{role:"user",content:s}],t={model:this.opts.get("ai."+this.promptType+".model"),messages:e},this.opts.is("ai.text.stream")?((s=this._getInsertedNode()).html(this.defaults.spinner),this.app.dropdown.close(),this.app.context.close(),this._sendStream(s,e)):this._sendPrompt(t,"_insert"))},_sendPrompt(t,e){let s={url:this.opts.get("ai."+this.promptType+".endpoint"),data:JSON.stringify(t)};this.ajax.request("post",{url:this.opts.get("ai."+this.promptType+".url"),data:s,before:function(t){if(this.app.broadcast("ai.before.send",{xhr:t,data:s}).isStopped())return!1}.bind(this),success:this[e].bind(this),error:this._error.bind(this)})},_sendStream(s,t,i){var e=this.opts.get("ai."+this.promptType+".model"),r=this.opts.get("ai."+this.promptType+".endpoint"),a=this.opts.get("ai."+this.promptType+".url"),e={model:e,stream:this.opts.get("ai.text.stream"),messages:i?this.conversation:t},t={url:r,data:JSON.stringify(e)};let o="",p=this._createSource(a,t),n=(this.isEvent=p,this.currentIndex=0,this.app.scroll.getTarget());s.removeClass("rx-inserted-node-started"),p.addEventListener("message",function(t){this.app.dropdown.close(),this.app.context.close();var t=t.data,e=t.indexOf(": ","data")+2,e=t.slice(e,t.length);"[DONE]"===e?this._sendStreamDone(p,s,o,i):(e=JSON.parse(e)).notification?this._sendStreamDone(p,s,e.notification,i):(t=e.choices)&&0<t.length&&(e=t[0].delta.content)&&(s.hasClass("rx-inserted-node-started")||(s.html(""),this._sendStreamPreviewSet(i)),o+=e,this._typeCharacter(s,o),this._isElementBottomBeyond(s.get())&&(s.get().scrollIntoView(!1),n.scrollTop(n.scrollTop()+20)),s.addClass("rx-inserted-node-started"))}.bind(this)),p.addEventListener("error",function(t){this._error(t),p.close(),this.isEvent=!1}.bind(this))},_sendStreamDone(t,e,s,i){if(i){let t=setInterval(function(){this.currentIndex===s.length&&(clearInterval(t),this.stopPrompt(!1,s),this.conversation.push({role:"assistant",content:s}))}.bind(this),100)}else this._insertAfterNode(e,s);t.close(),this.isEvent=!1},_sendStreamPreviewSet(t){t&&(t=this.$textarea.val(),this.$progress.html(""),this.$previewLabel.html(this._sanitize(t)),this.$textarea.val(""),this.$preview.html(""),this.$preview.css({"white-space":"pre-wrap"}),this.$generate.hide(),this.$stop.show())},_buildNode(t,e){let s;var i;return this.instance=!1,this.app.blocks.is()?(this.app.editor.isSelectAll()||(s=(s=this.app.blocks.get({first:!0,selected:!0})).closest("[data-rx-first-level]")).before(t),i=this.app.editor.isSelectAll(),s=this.app.blocks.removeAll(),i&&(t=s)):(this.instance=this.app.block.get(),this.instance.isType("listitem")?this.instance.getBlock().html("").append(t):this.instance.isType("todoitem")?this.instance.getContentItem().html("").append(t):(this.instance.getBlock().before(t),this.app.block.remove(e))),t},_buildPrompt(t){this.conversation=[],this.$prompt=this._createPrompt(t),this.$textarea.on("input focus",function(){this.app.block.setTool("ai")}.bind(this));let e,s=this.app.block.get(),i=this.app.blocks.is();this.app.dropdown.close(),this.app.context.close(),s||i?(e=(s=i?this.app.blocks.get({last:!0,selected:!0,instances:!0}):s).getFirstLevel(),this._insertPrompt(this.$prompt,e),i&&this.app.blocks.unset()):this._insertPrompt(this.$prompt)},_error(t,e){var s=this.app.editor.getEditor().find(".rx-inserted-node");0!==s.length&&(this.app.dropdown.close(),this.app.context.close(),this.app.create("insertion").insert({target:s,remove:!0,caret:"end",html:this.promptHtml})),this.$progress&&this.$progress.fadeOut(500,function(){this.$progress.html("").removeAttr("style")}.bind(this)),this.app.broadcast("ai.error",t||e)},_insert(t){if(this.promptButton.setIcon(""),t.error)return this._error(t.error.message,t);if(!t.choices)return this._error(t);var t=t.choices[0].message.content,t=this._parseReply(t),e=this.app.create("insertion");this.app.dropdown.close(),this.app.context.close();let s;var i=this.instance&&this.instance.isType(["listitem","todoitem"]);s=i?(this.instance.setContent(content),this.instance.getBlock()):(i=this._getNode(),this.app.block.set(i),e.insert({html:t,caret:"end"})),this.app.broadcast("ai.insert",{nodes:s})},_complete(t){let e;var s=this.$textarea.val();let i;if(this.$progress.html(""),this.$previewLabel.html(""),t.error)return this._error(t.error.message,t);if(t.notification)this.$preview.html(t.notification+"<br>");else{if(this.$previewLabel.html(this._sanitize(s)),this.$textarea.val(""),this.$textarea.focus(),"text"===this.promptType){if(!t.choices)return this._error(t);s=t.choices[0].message.content,this.conversation.push({role:"assistant",content:s}),e=this._parseReply(s),i=e,this.$preview.html(e),this.$insert.show()}else if("image"===this.promptType){if(!t.data)return this._error(t);s=t.data[0].url,e=t.data[0].revised_prompt;t=this.dom("<img>").attr("src",s);i=t.get().outerHTML,this.$preview.html(t),this.$insert.show()}s=this.$previewLabel.text();this.app.broadcast("ai.complete",{prompt:s,response:i})}},_parseReply(t){var e=this.app.create("utils"),s=this.app.create("cleaner");t=e.parseLists(t),t=s.store(t,"lists");let i=this._parseMarkdown(t);return i=(i=(i=(i=s.restore(i,"lists")).replace(/<p><(ul|ol)>/g,"<$1>")).replace(/<\/(ul|ol)><\/p>/g,"</$1>")).replace(/<p><\/p>/g,"")},_createPrompt(t){t=Redactor.extend(!0,{},{image:!1},t),this.promptType=t.image?"image":"text";var t=this.lang.get("ai.placeholder-"+this.promptType),e=(this.app.editor.getEditor().find(".rx-ai-main").remove(),this.dom('<div class="rx-in-tool rx-ai-main">').attr({contenteditable:!1})),s=this.dom('<div class="rx-ai-body">'),i=this.dom('<div class="rx-ai-footer">'),r=this.dom('<div class="rx-ai-buttons">');return this.$progress=this.dom('<div class="rx-ai-progress">'),this.$previewLabel=this.dom('<div class="rx-ai-preview-label">'),this.$preview=this.dom('<div class="rx-ai-preview">'),this.$prompt=this.dom('<div class="rx-ai-prompt">'),this.$label=this.dom('<label class="rx-ai-label">').html(this.lang.get("ai.prompt")),this.$textarea=this.dom('<textarea class="rx-ai-textarea rx-form-textarea">').attr({placeholder:t}),this.$select=this.dom('<select class="rx-ai-select rx-form-select">'),this.$size=this.dom('<select class="rx-ai-size rx-form-select">'),this._createPromptFooter(i,r),this.$prompt.append(this.$label),this.$prompt.append(this.$textarea),s.append(this.$progress),s.append(this.$previewLabel),s.append(this.$preview),s.append(this.$prompt),e.append(s),e.append(i),e},_createPromptFooter(t,e){this._createTone(this.$select),this._createSize(this.$size),this._createPromptButtons(e),t.append(this.$select),"image"===this.promptType&&t.append(this.$size),t.append(e)},_createPromptButton(t){return this.dom('<button class="rx-ai-button rx-form-button">').html(t)},_createSize(t){var e,s,i=this.opts.get("ai.size");for([e,s]of Object.entries(i)){var r=this.dom("<option>").val(e).html(s);t.append(r)}},_createTone(e){var s="image"===this.promptType?this.opts.get("ai.style")||this.defaults.style:this.opts.get("ai.tone")||this.defaults.tone,i="image"===this.promptType?this.lang.get("ai.image-style"):this.lang.get("ai.change-tone"),r=this.dom("<option>").val(0).html(i);e.append(r),r=this.dom("<option>").val(1).html("---"),e.append(r);for(let t=0;t<s.length;t++)i=s[t],r=this.dom("<option>").val(i).html(i),e.append(r)},_createPromptButtons(t){this.$generate=this._createPromptButton(this.lang.get("ai.send")).addClass("rx-form-button-primary").on("click.rx-ai",this.sendPrompt.bind(this)),this.$stop=this._createPromptButton(this.lang.get("ai.stop")).addClass("rx-form-button-primary").on("click.rx-ai",this.stopPrompt.bind(this)).hide(),this.$discard=this._createPromptButton(this.lang.get("ai.discard")).addClass("rx-form-button-danger").on("click.rx-ai",this.closePrompt.bind(this)),this.$insert=this._createPromptButton(this.lang.get("ai.insert")).on("click.rx-ai",this.insertPrompt.bind(this)).hide(),t.append(this.$discard),t.append(this.$insert),t.append(this.$stop),t.append(this.$generate)},_createSource(t,e){const i=new EventTarget;let r=this.ajax.post({url:t,data:e,before:function(t){if(this.app.broadcast("ai.before.send",{xhr:t,data:e}).isStopped())return!1}.bind(this)}).xhr,a=this;var o=!1,p=0;return r.onprogress=function(){var t,e;if(o||(o=!0,i.dispatchEvent(new Event("open",{status:r.status,headers:r.getAllResponseHeaders(),url:r.responseUrl}))),a._isJsonString(r.responseText)){var s=JSON.parse(r.responseText);if(s.error)return a._error(s.error.message,s),void i.close()}for(;0<=(t=r.responseText.indexOf("\n\n",p));)e=r.responseText.slice(p,t),p=t+2,e.length&&i.dispatchEvent(new MessageEvent("message",{data:e}))},i.close=function(){r.abort()},i},_isElementBottomBeyond(t){var e=this.app.scroll.getTarget(),t=t.getBoundingClientRect();return t.top+t.height>e.get().innerHeight},_isJsonString(t){try{JSON.parse(t)}catch(t){return!1}return!0},_insertAfterNode(t,e){let s;var i,r=this.instance&&this.instance.isType(["listitem","todoitem"]);s=r?(this.instance.setContent(e),this.instance.getBlock()):(r=this.app.create("insertion"),i=this.app.block.create().getBlock(),e=this._parseReply(e),t.after(i),t.remove(),this.app.block.set(i),r.insert({html:e,caret:"end"})),this.app.broadcast("ai.insert",{nodes:s})},_insertPrompt(t,e,s){let i=this.app.create("element"),r="after";e||(r="top"===this.opts.get("addPosition")?(e=this.app.blocks.get({first:!0,instances:!0}),"before"):(e=this.app.blocks.get({last:!0,instances:!0}),"after")),e.getBlock()[r](t),i.scrollTo(t),this.app.observer.observeUnset(),this.$textarea.focus(),this.$textarea.on("input.rx-ai-autoresize keyup.rx-ai-autoreize",this._resize.bind(this)),this.$textarea.on("keydown.rx-ai-event",this._promptKeydown.bind(this))},_promptKeydown(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendPrompt(t))},_typeCharacter(t,e){this.currentIndex<e.length&&(t.get().textContent+=e.charAt(this.currentIndex),this.currentIndex++,setTimeout(function(){this._typeCharacter(t,e)}.bind(this),100))},_resize(){this.$textarea.css("height","auto"),this.$textarea.css("height",this.$textarea.get().scrollHeight+"px")},_sanitize(t){return t.replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;"}})},_parseMarkdown(t){let e=!1,s="";for(const i of t.split("\n"))i.startsWith("```")?(e=!e,s+=e?this._replaceCodeLine(i):"</code></pre>"):s+=e?this._escapeHtml(i)+"\n":`<p>${this._escapeHtml(i)}</p>`;return s},_replaceCodeLine(t){return t.replace(/\`\`\`(([^\s]+))?/gm,function(t,e,s){return"<pre"+(s?' class="'+s+'"':"")+"><code>"})},_escapeHtml(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>"']/g,t=>e[t])}});